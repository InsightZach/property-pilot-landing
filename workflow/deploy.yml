/name: Deploy Backend Application

on:
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16' # Specify your Node.js version

      - name: Install Dependencies
        run: npm install

      - name: Build Application
        run: npm run build # If you have a build script

      - name: Archive Production Artifacts
        run: |
          mkdir -p artifact
          cp -r * artifact/
          tar -czf artifact.tar.gz -C artifact .
          ls -la
          
      - name: Install SSH Key
        uses: webfactory/ssh-agent@v0.5.4
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Deploy to Server
        run: |
          scp artifact.tar.gz user@your-server-ip:/home/user/
          ssh user@your-server-ip 'bash -s' << 'ENDSSH'
            # Commands to run on the server
            cd /home/user/
            tar -xzf artifact.tar.gz -C /path/to/your/app
            cd /path/to/your/app
            npm install --production
            pm2 stop all || true
            # Export environment variables
            export EMAIL_HOST='${{ secrets.EMAIL_HOST }}'
            export EMAIL_PORT='${{ secrets.EMAIL_PORT }}'
            export EMAIL_SECURE='${{ secrets.EMAIL_SECURE }}'
            export EMAIL_USER='${{ secrets.EMAIL_USER }}'
            export EMAIL_PASS='${{ secrets.EMAIL_PASS }}'
            export EMAIL_FROM='${{ secrets.EMAIL_FROM }}'
            pm2 start server.js --name "my-app"
          ENDSSH
        env:
          EMAIL_HOST: ${{ secrets.EMAIL_HOST }}
          EMAIL_PORT: ${{ secrets.EMAIL_PORT }}
          EMAIL_SECURE: ${{ secrets.EMAIL_SECURE }}
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
